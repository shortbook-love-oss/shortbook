generator client {
  provider                = "prisma-client-js"
}

datasource db {
  provider                = "mysql"
  url                     = env("DATABASE_URL")
}

// -----------------------------------------------------------------------
// User
// -----------------------------------------------------------------------

model users {
  id                      String              @id @db.VarChar(26) @default(ulid())
  key_handle              String              @unique @db.VarChar(30) // Length 1 - 30
  pen_name                String              @db.VarChar(210) // Length 1 - 50
  email                   String              @db.VarChar(510) // Encrypted
  email_hash              String              @unique @db.VarChar(127)
  native_language_tag     String              @db.VarChar(5)
  image_src               String              @db.VarChar(510)
  is_admin                Boolean
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  sessions                sessions[]
  languages               user_languages[]
  points                  user_points[]
  fans                    user_fans[]
  payment_checkouts       user_payment_checkouts[]
  payment_setting         user_payment_settings?
  payment_contracts       user_payment_contracts[]
  images                  user_images[]
  books                   books[]

  @@index([pen_name])
}

model sessions {
  user                    users               @relation(fields: [user_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  user_id                 String              @db.VarChar(26)
  session_token           String              @unique
  expires                 DateTime
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?
}

model user_languages {
  user                    users               @relation(fields: [user_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  user_id                 String              @db.VarChar(26)
  language_tag            String              @db.VarChar(5)
  headline                String              @db.VarChar(210) // Length 1 - 50
  self_introduction       String              @db.MediumText
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  @@unique([user_id, language_tag])
}

model user_points {
  user                    users               @relation(fields: [user_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  user_id                 String              @db.VarChar(26)
  payment_checkout_id     String              @db.VarChar(36) // For charge
  amount                  Int
  book_id                 String              @db.VarChar(26) // For buy book
  is_refund               Int                 @db.SmallInt // Use when refunding bought book
  is_sell                 Int                 @db.SmallInt // Use when writer sold book
  is_income               Int                 @db.SmallInt // Use when user's point → money received
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?
}

model user_fans {
  target_user             users               @relation(fields: [target_user_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  target_user_id          String              @db.VarChar(26)
  support_user_id         String              @db.VarChar(26)
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  @@index([support_user_id])
}

model user_payment_checkouts {
  user                    users               @relation(fields: [user_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  user_id                 String              @db.VarChar(26)
  provider_key            String              @db.VarChar(15)
  session_id              String              // Encrypted
  currency                String              @db.VarChar(3)
  amount                  Decimal
  is_refund               Int                 @db.SmallInt
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?
}

model user_payment_settings {
  user                    users               @relation(fields: [user_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  user_id                 String              @unique @db.VarChar(26)
  currency                String              @db.VarChar(3)
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?
}

model user_payment_contracts {
  user                    users               @relation(fields: [user_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  user_id                 String              @db.VarChar(26)
  provider_key            String              @db.VarChar(15)
  provider_customer_id    String              // Encrypted
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  @@unique([provider_key, provider_customer_id])
}

// -----------------------------------------------------------------------
// User album
// -----------------------------------------------------------------------

model user_images {
  user                    users               @relation(fields: [user_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  user_id                 String              @db.VarChar(26)
  name                    String              @db.VarChar(1400) // Length 0 - 250
  alt                     String              @db.VarChar(1000) // Length 0 - 150
  image_created_at        DateTime?           @db.Date() // Filmed date or drew date, not published date
  in_image_language_tag   String              @db.VarChar(5)
  place                   String              @db.VarChar(255)
  is_sensitive            Int                 @db.SmallInt // 0: No 1: Yes
  is_ai                   Int                 @db.SmallInt // 0: No 1: Yes (edited) 2: Yes (generated)
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  property                user_image_properties?
  license                 user_image_licenses?
  tags                    user_image_tags[]
}

model user_image_properties {
  image                   user_images         @relation(fields: [image_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  image_id                String              @unique @db.VarChar(26)
  saved_file_name         String              @db.VarChar(31)
  byte_length             Int
  width                   Int
  height                  Int
  mime_type               String              @db.VarChar(31)
  checksum                String              @db.VarChar(44) // SHA-256
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?
}

model user_image_licenses {
  image                   user_images         @relation(fields: [image_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  image_id                String              @unique @db.VarChar(26)
  creator_type            Int                 @db.SmallInt // 1: Person 2: Organization
  creator_name            String              @db.VarChar(350) // Length 1 - 50
  copyright_owner         String              @db.VarChar(350) // Length 0 - 50
  target_in_image         String              @db.VarChar(700) // Length 0 - 100
  license_url             String              @db.VarChar(255)
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?
}

model user_image_tags {
  image                   user_images         @relation(fields: [image_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  image_id                String              @db.VarChar(26)
  name                    String              @db.VarChar(350) // Length 1 - 50
  sort                    Int                 @db.SmallInt
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  @@index([name])
}

// -----------------------------------------------------------------------
// Book
// -----------------------------------------------------------------------

model books {
  user                    users               @relation(fields: [user_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  user_id                 String              @db.VarChar(26)
  is_admin                Boolean
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  revisions               book_revisions[]
  buys                    book_buys[]
}

model book_revisions {
  book                    books               @relation(fields: [book_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  book_id                 String              @db.VarChar(26)
  number                  Int
  status                  Int                 @db.SmallInt // 0: Draft 1: Published
  url_slug                String              @db.VarChar(100) // Length 1 - 100
  buy_point               Int
  native_language_tag     String              @db.VarChar(5)
  is_translate_to_all     Boolean
  title                   String              @db.VarChar(1400) // Max length is 200
  subtitle                String              @db.VarChar(1400) // Max length is 200
  free_area               String              @db.LongText
  paid_area               String              @db.LongText
  sales_area              String              @db.LongText
  has_free_area           Boolean
  has_paid_area           Boolean
  has_sales_area          Boolean
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  translate_languages     book_translate_languages[]
  contents                book_contents[]
  cover                   book_covers?

  @@unique([book_id, number])
}

model book_translate_languages {
  book_revision           book_revisions      @relation(fields: [revision_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  revision_id             String              @db.VarChar(26)
  language_tag            String              @db.VarChar(5)
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?
}

model book_contents {
  book_revision           book_revisions      @relation(fields: [revision_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  revision_id             String              @db.VarChar(26)
  language_tag            String              @db.VarChar(5)
  title                   String              @db.VarChar(1400) // Max length is 200
  subtitle                String              @db.VarChar(1400) // Max length is 200
  free_area_html          String              @db.LongText
  paid_area_html          String              @db.LongText
  sales_area_html         String              @db.LongText
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  @@unique([revision_id, language_tag])
}

model book_covers {
  book_revision           book_revisions      @relation(fields: [revision_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  revision_id             String              @unique @db.VarChar(26)
  base_color_start        String              @db.VarChar(15) // Hex code with "#"
  base_color_end          String              @db.VarChar(15)
  base_color_direction    Int                 @db.SmallInt // 0: bottom→top 90: left→right
  title_font_size         Int                 @db.SmallInt // Font size unit is "px"
  title_align             String              @db.VarChar(7)
  title_color             String              @db.VarChar(15)
  subtitle_font_size      Int                 @db.SmallInt
  subtitle_align          String              @db.VarChar(7)
  subtitle_color          String              @db.VarChar(15)
  writer_align            String              @db.VarChar(7)
  writer_color            String              @db.VarChar(15)
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?
}

model book_buys {
  book                    books               @relation(fields: [book_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  book_id                 String              @db.VarChar(26)
  user_id                 String              @db.VarChar(26)
  point_spend             Int                 // It won't change if writer change the price later
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  @@unique([book_id, user_id])
}

// -----------------------------------------------------------------------
// Contact
// -----------------------------------------------------------------------

model tickets {
  id                      String              @id @db.VarChar(26) @default(ulid())
  category_key_name       String              @db.VarChar(31)
  person_name             String              @db.VarChar(700) // Length 0 - 100
  email                   String              @db.VarChar(510) // Encrypted
  description             String              @db.LongText
  from_language_tag       String              @db.VarChar(5)
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  files                   ticket_files[]
}

model ticket_files {
  ticket                  tickets             @relation(fields: [ticket_id], references: [id], onUpdate: Cascade)

  id                      String              @id @db.VarChar(26) @default(ulid())
  ticket_id               String              @db.VarChar(26)
  file_url                String              @db.VarChar(510)
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?
}

// -----------------------------------------------------------------------
// Verification token
// -----------------------------------------------------------------------

model verification_tokens {
  identifier              String
  token                   String              @db.VarChar(510)
  user_id                 String?             @db.VarChar(26)
  expires                 DateTime

  @@unique([identifier, token])
}

// -----------------------------------------------------------------------
// Limit rate control
// -----------------------------------------------------------------------

model log_actions {
  id                      String              @id @db.VarChar(26) @default(ulid())
  action_name             String              @db.VarChar(31)
  ip_address_hash         String              @db.VarChar(127)
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?
}

// -----------------------------------------------------------------------
// Translated contents
// -----------------------------------------------------------------------

model translated_contents {
  id                      String              @id @db.VarChar(26) @default(ulid())
  user_id                 String              @db.VarChar(26)
  language_tag            String              @db.VarChar(5)
  checksum                String              @db.VarChar(44) @unique // SHA-256
  text                    String              @db.LongText
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?
}

// -----------------------------------------------------------------------
// Reference
// -----------------------------------------------------------------------

// Currency rate from 1 USD
model currency_rates {
  currency                String              @id @db.VarChar(3)
  rate                    Decimal
}
