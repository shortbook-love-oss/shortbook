generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------
// User
// -----------------------------------------------------------------------

model User {
  id                      String              @id @default(cuid())
  name                    String?
  email                   String?             @unique @db.VarChar(254)
  emailVerified           DateTime?           @map("email_verified")
  image                   String?             @db.VarChar(510)
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  accounts                Account[]
  authenticator           Authenticator[]
  sessions                Session[]
  profiles                user_profiles?
  fans                    user_fans[]
  books                   books[]

  @@map("users")
}

model Account {
  user                    User                @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  id                      String              @id @default(cuid())
  userId                  String              @map("user_id")
  type                    String
  provider                String
  providerAccountId       String              @map("provider_account_id")
  refresh_token           String?             @db.Text
  access_token            String?             @db.Text
  expires_at              Int?
  token_type              String?
  scope                   String?
  id_token                String?             @db.Text
  session_state           String?
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Authenticator {
  user                    User                @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  credentialID            String              @unique @map("credential_id")
  userId                  String              @map("user_id")
  providerAccountId       String              @map("provider_account_id")
  credentialPublicKey     String              @map("credential_public_key")
  counter                 Int
  credentialDeviceType    String              @map("credential_device_type")
  credentialBackedUp      Boolean             @map("credential_backed_up")
  transports              String?
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  @@id([userId, credentialID])
  @@map("authenticator")
}

model Session {
  user                    User                @relation(fields: [userId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  id                      String              @id @default(cuid())
  sessionToken            String              @unique @map("session_token")
  userId                  String              @map("user_id")
  expires                 DateTime
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  @@map("sessions")
}

model VerificationToken {
  identifier              String
  token                   String
  expires                 DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model user_profiles {
  user                    User                @relation(fields: [user_id], references: [id], onUpdate: Cascade, onDelete: Cascade)

  id                      String              @id @default(cuid())
  user_id                 String              @unique
  key_name                String              @unique @db.VarChar(30) // Length 1 - 30
  native_language         String              @db.VarChar(5)
  location                String              @db.VarChar(1022)
  birthday                DateTime?           @db.Date()
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  languages               user_profile_languages[]
}

model user_profile_languages {
  user_profile            user_profiles       @relation(fields: [profile_id], references: [id], onUpdate: Cascade, onDelete: Cascade)

  id                      String              @id @default(cuid())
  profile_id              String
  language_code           String              @db.VarChar(5)
  pen_name                String              @db.VarChar(210) // Length 1 - 50
  headline                String              @db.VarChar(210) // Length 1 - 50
  self_introduction       String              @db.MediumText
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  @@unique([profile_id, language_code])
}

model user_fans {
  target_user             User                @relation(fields: [target_user_id], references: [id], onUpdate: Cascade, onDelete: Cascade)

  id                      String              @id @default(cuid())
  target_user_id          String
  support_user_id         String
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?
}

// -----------------------------------------------------------------------
// Books
// -----------------------------------------------------------------------

model books {
  user                    User                @relation(fields: [user_id], references: [id], onUpdate: Cascade, onDelete: Cascade)

  id                      String              @id @default(cuid())
  user_id                 String
  status                  Int                 @db.SmallInt // 0: Draft 1: Public 2: Fan club only
  price                   Float               @db.Double
  published_at            DateTime            @default(now())
  edited_at               DateTime            @default(now())
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?

  languages               book_languages[]
  tags                    book_tags[]
  buys                    book_buys[]
}

model book_languages {
  book                    books               @relation(fields: [book_id], references: [id], onUpdate: Cascade, onDelete: Cascade)

  id                      String              @id @default(cuid())
  book_id                 String
  language_code           String              @db.VarChar(5)
  thumbnail_url           String              @db.VarChar(255)
  title                   String              @db.VarChar(1022) // Max length is 100
  introduction            String              @db.LongText
  content                 String              @db.LongText
  sales_message           String              @db.VarChar(8090) // Max length is 800
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?
}

model book_tags {
  book                    books               @relation(fields: [book_id], references: [id], onUpdate: Cascade, onDelete: Cascade)

  id                      String              @id @default(cuid())
  book_id                 String
  name                    String              @db.VarChar(510) // Max length is 50
  sort                    Int                 @db.SmallInt
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?
}

model book_buys {
  book                    books               @relation(fields: [book_id], references: [id], onUpdate: Cascade, onDelete: Cascade)

  id                      String              @id @default(cuid())
  book_id                 String
  user_id                 String
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt
  deleted_at              DateTime?
}
